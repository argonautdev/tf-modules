name: "Module testing using terratest"
on:
  workflow_dispatch:
    inputs:
      cloud_provider:
        description: 'Select Which Cloud Provider Modules to test out'
        type: choice
        default: aws
        options:
        - aws
        - gcp
      
      tf_module:
        description: 'Select Terraform Module to test using Terratest'
        required: true
        default: 'warning' 
        type: choice
        options:
        - vpc
        - rds
        - gke
        - gcs
jobs:
  terratest_all:
     name: init-and-apply
     runs-on: ubuntu-22.04
     steps:
        - name: Check out repository
          uses: actions/checkout@v3
        
        - name: Terratest for aws modules
          if:  ${{ inputs.cloud_provider }} == 'aws'
          run: |
            echo "list the directory structure"
            cd modules/${{ inputs.cloud_provider }}/${{ inputs.tf_module }}/test
            ls -la
        
        - name: change directory to list contents
          run: |
            echo "list the directory structure"
            cd modules/${{ inputs.cloud_provider }}/${{ inputs.tf_module }}
            ls -la
        
        - name: Installing GO
          uses: actions/setup-go@v3
          with:
            go-version: '^1.18.6' # The Go version .
        
        - name: Installing awscli
          ##It can be Java script files or public docker images. I am using awscli public docker images 
          uses: docker://amazon/aws-cli:2.7.24
          with:
            args: --version
        
        - name: aws, go cli version
          run: |
            aws --version 
            go version
            
        # Runs a aws cli command to list ecr repos
        - name: Runs a aws cli to see account information
          id: retrieve_account_information 
          run: |
            aws sts get-caller-identity